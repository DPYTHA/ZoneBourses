<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="web icon" href="/static/images/logo.jpeg">
    <title>Administration - ZoneBourse</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .media-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .media-preview {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
        }
        
        .media-preview img, .media-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-media {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .media-type-badge {
            position: absolute;
            bottom: 2px;
            left: 2px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 10px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/dashboard" class="nav-logo">
                <svg class="logo-svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/>
                </svg>
                ZoneBourse
            </a>
            <div class="nav-menu" id="navMenu">
                <a href="/dashboard" class="nav-link">Tableau de bord</a>
                <a href="/admin/users">Utilisateurs</a>
                <span class="user-welcome" id="userWelcome">Panel Admin</span>
                <a href="/api/logout" class="nav-link" id="logoutBtn">Déconnexion</a>
            </div>
            <div class="nav-toggle" id="navToggle">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Panel d'administration -->
    <div class="dashboard">
        <div class="dashboard-header">
            <h1 class="welcome-message">Panel <span>Administration</span></h1>
        </div>

        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="40" height="40">
                        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                    </svg>
                </div>
                <div class="stat-number" id="statsUsers">0</div>
                <div class="stat-label">Utilisateurs</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="40" height="40">
                        <path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/>
                    </svg>
                </div>
                <div class="stat-number" id="statsBourses">0</div>
                <div class="stat-label">Bourses actives</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="40" height="40">
                        <path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/>
                    </svg>
                </div>
                <div class="stat-number" id="statsUniversites">0</div>
                <div class="stat-label">Universités</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="40" height="40">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                    </svg>
                </div>
                <div class="stat-number" id="statsPays">0</div>
                <div class="stat-label">Pays</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Gestion des Bourses</h2>
            <div style="text-align: center; margin-bottom: 40px;">
                <button class="btn btn-filled" onclick="openModal('addBourseModal')" style="padding: 16px 32px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Ajouter une bourse
                </button>
            </div>
            
            <div class="bourses-grid" id="adminBoursesGrid">
                <!-- Les bourses seront chargées dynamiquement -->
            </div>
        </div>
    </div>

    <!-- Modal d'ajout de bourse -->
    <div id="addBourseModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 40px; border-radius: var(--radius); max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="font-size: 1.5rem; font-weight: 700; margin: 0;">Ajouter une nouvelle bourse</h3>
                <button type="button" onclick="closeModal('addBourseModal')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color);">&times;</button>
            </div>
            
            <form id="addBourseForm" enctype="multipart/form-data">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group">
                        <label class="form-label">Titre *</label>
                        <input type="text" class="form-input" name="titre" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Université *</label>
                        <input type="text" class="form-input" name="universite" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description *</label>
                    <textarea class="form-input" name="description" rows="3" required placeholder="Décrivez la bourse en détail..."></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group">
                        <label class="form-label">Pays *</label>
                        <input type="text" class="form-input" name="pays" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Niveau d'études *</label>
                        <select class="form-input" name="niveau_etude" required>
                            <option value="">Sélectionner</option>
                            <option value="Licence">Licence</option>
                            <option value="Master">Master</option>
                            <option value="Doctorat">Doctorat</option>
                            <option value="MBA">MBA</option>
                            <option value="Post-Doctorat">Post-Doctorat</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group">
                        <label class="form-label">Domaine d'études *</label>
                        <input type="text" class="form-input" name="domaine_etude" required placeholder="Ex: Informatique, Génie Civil...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Montant de la bourse *</label>
                        <input type="text" class="form-input" name="montant_bourse" required placeholder="Ex: 15 000€ par an">
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group">
                        <label class="form-label">Date limite *</label>
                        <input type="date" class="form-input" name="date_limite" required>
                    </div>
                </div>

                <!-- Section Image Principale -->
                <div class="form-group">
                    <label class="form-label">Image principale</label>
                    <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 10px;">
                        <input type="file" id="imageInput" name="image" accept="image/*" style="display: none;">
                        <div id="imagePreview" style="margin-bottom: 10px;"></div>
                        <button type="button" onclick="document.getElementById('imageInput').click()" class="btn btn-outline" style="padding: 8px 16px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                            Choisir une image
                        </button>
                        <p style="font-size: 0.8rem; color: #666; margin-top: 8px;">
                            Formats: JPG, PNG, GIF (Max: 10MB)
                        </p>
                    </div>
                </div>

                <!-- Section Vidéo -->
                <div class="form-group">
                    <label class="form-label">Vidéo de présentation (optionnel)</label>
                    <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 10px;">
                        <input type="file" id="videoInput" name="video" accept="video/*" style="display: none;">
                        <div id="videoPreview" style="margin-bottom: 10px;"></div>
                        <button type="button" onclick="document.getElementById('videoInput').click()" class="btn btn-outline" style="padding: 8px 16px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                                <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/>
                            </svg>
                            Choisir une vidéo
                        </button>
                        <p style="font-size: 0.8rem; color: #666; margin-top: 8px;">
                            Formats: MP4, MOV, AVI (Max: 50MB)
                        </p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Conditions d'éligibilité *</label>
                    <textarea class="form-input" name="conditions" rows="4" required placeholder="Listez les conditions requises pour postuler..."></textarea>
                </div>
                
                <!-- Modifiez cette section dans votre admin.html -->
<div class="form-group">
    <label class="form-label">Procédure de postulation *</label>
    <textarea class="form-input" name="procedure_postulation" id="procedureTextarea" rows="4" required placeholder="Décrivez les étapes de candidature..."></textarea>
    
    <!-- Section Médias pour la procédure -->
    <label class="form-label" style="margin-top: 16px; display: block;">
        Médias pour illustrer la procédure (optionnel)
    </label>
    <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 10px;">
        <!-- CHANGEMENT ICI : nom du fichier correct -->
        <input type="file" id="procedureMediasInput" name="procedure_medias" multiple accept="image/*,video/*" style="display: none;">
        <div id="procedureMediasPreview" class="media-preview-container"></div>
        <button type="button" onclick="document.getElementById('procedureMediasInput').click()" class="btn btn-outline" style="padding: 8px 16px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px;">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            Ajouter des médias
        </button>
        <p style="font-size: 0.8rem; color: #666; margin-top: 8px;">
            Images et vidéos pour illustrer les étapes (Max: 5 fichiers, 10MB chacun)
        </p>
    </div>
</div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('addBourseModal')">Annuler</button>
                    <button type="submit" class="btn btn-filled" id="submitBourseBtn">
                        <span id="submitBourseText">Ajouter la bourse</span>
                        <span id="submitBourseLoading" style="display: none;" class="loading"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="/static/js/script.js"></script>
    <script>
        // Gestion des médias
        let procedureMedias = [];
        
        // Configuration des prévisualisations
        document.getElementById('imageInput').addEventListener('change', function(e) {
            previewMedia(e.target, 'imagePreview', 'image');
        });
        
        document.getElementById('videoInput').addEventListener('change', function(e) {
            previewMedia(e.target, 'videoPreview', 'video');
        });
        
        document.getElementById('procedureMediasInput').addEventListener('change', function(e) {
            handleProcedureMedias(e.target.files);
        });
        
        function previewMedia(input, previewContainerId, type) {
            const previewContainer = document.getElementById(previewContainerId);
            previewContainer.innerHTML = '';
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const preview = document.createElement('div');
                    preview.className = 'media-preview';
                    
                    if (type === 'image') {
                        preview.innerHTML = `
                            <img src="${e.target.result}" alt="Prévisualisation">
                            <button type="button" class="remove-media" onclick="removeMedia('${previewContainerId}')">×</button>
                        `;
                    } else if (type === 'video') {
                        preview.innerHTML = `
                            <video controls>
                                <source src="${e.target.result}" type="${file.type}">
                            </video>
                            <button type="button" class="remove-media" onclick="removeMedia('${previewContainerId}')">×</button>
                        `;
                    }
                    
                    previewContainer.appendChild(preview);
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        function handleProcedureMedias(files) {
            const previewContainer = document.getElementById('procedureMediasPreview');
            const maxFiles = 5;
            
            // Limiter à 5 fichiers
            const filesToAdd = Array.from(files).slice(0, maxFiles - procedureMedias.length);
            
            filesToAdd.forEach(file => {
                // Vérifier la taille (10MB max)
                if (file.size > 10 * 1024 * 1024) {
                    alert(`Le fichier "${file.name}" dépasse la taille limite de 10MB`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const mediaId = Date.now() + Math.random();
                    const isVideo = file.type.startsWith('video/');
                    const isImage = file.type.startsWith('image/');
                    
                    const preview = document.createElement('div');
                    preview.className = 'media-preview';
                    preview.dataset.id = mediaId;
                    
                    if (isImage) {
                        preview.innerHTML = `
                            <img src="${e.target.result}" alt="${file.name}">
                            <button type="button" class="remove-media" onclick="removeProcedureMedia('${mediaId}')">×</button>
                            <span class="media-type-badge">IMG</span>
                        `;
                    } else if (isVideo) {
                        preview.innerHTML = `
                            <video controls>
                                <source src="${e.target.result}" type="${file.type}">
                            </video>
                            <button type="button" class="remove-media" onclick="removeProcedureMedia('${mediaId}')">×</button>
                            <span class="media-type-badge">VID</span>
                        `;
                    }
                    
                    previewContainer.appendChild(preview);
                    
                    // Stocker le fichier
                    procedureMedias.push({
                        id: mediaId,
                        file: file,
                        preview: preview
                    });
                };
                
                reader.readAsDataURL(file);
            });
            
            // Mettre à jour le compteur
            updateMediaCount();
        }
        
        function removeMedia(previewContainerId) {
            const previewContainer = document.getElementById(previewContainerId);
            previewContainer.innerHTML = '';
            
            // Réinitialiser l'input file
            if (previewContainerId === 'imagePreview') {
                document.getElementById('imageInput').value = '';
            } else if (previewContainerId === 'videoPreview') {
                document.getElementById('videoInput').value = '';
            }
        }
        
        function removeProcedureMedia(mediaId) {
            // Retirer de l'array
            const index = procedureMedias.findIndex(m => m.id == mediaId);
            if (index > -1) {
                procedureMedias.splice(index, 1);
            }
            
            // Retirer du DOM
            const preview = document.querySelector(`.media-preview[data-id="${mediaId}"]`);
            if (preview) {
                preview.remove();
            }
            
            updateMediaCount();
        }
        
        function updateMediaCount() {
            const count = procedureMedias.length;
            const max = 5;
            const label = document.querySelector('label[for="procedureMediasInput"]');
            if (label) {
                label.textContent = `Médias pour illustrer la procédure (${count}/${max})`;
            }
        }
        
        // Gestion de la soumission du formulaire
        document.getElementById('addBourseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBourseBtn');
            const submitText = document.getElementById('submitBourseText');
            const submitLoading = document.getElementById('submitBourseLoading');
            
            // Afficher le loader
            submitText.style.display = 'none';
            submitLoading.style.display = 'inline-block';
            submitBtn.disabled = true;
            
            try {
                // Créer un FormData
                const formData = new FormData(this);
                
                // Ajouter les médias de procédure
                procedureMedias.forEach((media, index) => {
                    formData.append(`procedure_media_${index}`, media.file);
                });
                
                // Ajouter le nombre de médias
                formData.append('procedure_medias_count', procedureMedias.length);
                
                // Envoyer la requête
                const response = await fetch('/api/admin/bourses', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Bourse ajoutée avec succès !');
                    closeModal('addBourseModal');
                    resetForm();
                    // Recharger la liste des bourses
                    loadAdminBourses();
                } else {
                    alert('❌ Erreur: ' + (result.error || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('❌ Erreur lors de l\'ajout de la bourse');
            } finally {
                // Réinitialiser le bouton
                submitText.style.display = 'inline';
                submitLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
        
        function resetForm() {
            document.getElementById('addBourseForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('videoPreview').innerHTML = '';
            document.getElementById('procedureMediasPreview').innerHTML = '';
            procedureMedias = [];
            updateMediaCount();
        }
        
        // Fonctions de modal
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            resetForm();
        }
        
        // Charger les bourses
        async function loadAdminBourses() {
            try {
                const response = await fetch('/api/admin/bourses');
                const bourses = await response.json();
                
                const grid = document.getElementById('adminBoursesGrid');
                grid.innerHTML = '';
                
                bourses.forEach(bourse => {
                    const card = document.createElement('div');
                    card.className = 'bourse-card';
                    card.innerHTML = `
                        <div class="bourse-header">
                            <div class="bourse-image">
                                ${bourse.image_url ? 
                                    `<img src="${bourse.image_url}" alt="${bourse.titre}">` : 
                                    `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 120px; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                                        <svg viewBox="0 0 48 48" fill="white" width="60" height="60">
                                            <path d="M24 4L6 14v20l18 10 18-10V14L24 4zm0 6l12 6.87v14.26L24 38 12 31.13V16.87L24 10z"/>
                                            <path d="M20 22l8 4.62V34l-8-4.62V22z"/>
                                        </svg>
                                    </div>`
                                }
                            </div>
                        </div>
                        <div class="bourse-content">
                            <h3 class="bourse-title">${bourse.titre}</h3>
                            <div class="bourse-university">${bourse.universite}, ${bourse.pays}</div>
                            <p class="bourse-description">${bourse.description.substring(0, 100)}...</p>
                            <div class="bourse-actions">
                                <button class="btn-small btn-outline" onclick="editBourse(${bourse.id})">Modifier</button>
                                <button class="btn-small btn-danger" onclick="deleteBourse(${bourse.id})">Supprimer</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        // Charger au démarrage
        document.addEventListener('DOMContentLoaded', function() {
            loadAdminBourses();
        });
        
        // Gérer les clics en dehors du modal
        window.onclick = function(event) {
            if (event.target.id === 'addBourseModal') {
                closeModal('addBourseModal');
            }
        };
    </script>
</body>
</html>